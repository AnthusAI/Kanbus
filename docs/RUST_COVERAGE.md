# Rust Coverage

## Source of truth

Rust coverage is produced with `cargo llvm-cov` and exported as Cobertura XML at `coverage-rust/cobertura.xml`. The CI workflow reads that file to publish the Rust coverage badge.

## Required tooling

```bash
rustup component add llvm-tools-preview
cargo install cargo-llvm-cov --locked
```

## Console assets (required for embed-assets)

The Rust coverage run enables `--all-features`, which includes `embed-assets`. The embedded console assets must exist under `rust/embedded_assets/console`.

```bash
(cd packages/ui && npm ci && npm run build)
(cd apps/console && npm ci && npm run build)
rm -rf rust/embedded_assets/console
cp -R apps/console/dist rust/embedded_assets/console
```

## Run coverage

```bash
cd rust
mkdir -p ../coverage-rust
cargo llvm-cov --locked --no-report --all-features --lib --bins --tests --ignore-filename-regex "features/steps/.*|src/bin/.*|src/main.rs"
cargo llvm-cov report --locked --cobertura --output-path ../coverage-rust/cobertura.xml
```

## Run via the combined spec runner

This runs Python specs and Rust specs + coverage in one command. Use the py311 environment for the Python runner.

```bash
conda run -n py311 python tools/run_specs.py
```

## Badge generation

The Rust coverage badge is generated by `.github/workflows/ci.yml`:

- The `rust` job runs `cargo llvm-cov` and writes `coverage-rust/cobertura.xml`.
- The `badges` job calls `tools/coverage_badge.py` and writes `badges/rust-coverage.svg`.
- The `badges` job publishes the `badges` branch, and the README points to:
  `https://raw.githubusercontent.com/AnthusAI/Kanbus/badges/rust-coverage.svg`

If the Rust job fails before the coverage XML is produced, the badge will not update.

## Troubleshooting

- `cargo llvm-cov` missing: install with `cargo install cargo-llvm-cov --locked`.
- `llvm-tools-preview` missing: run `rustup component add llvm-tools-preview`.
- `embedded_assets/console` missing: rebuild console assets and copy into `rust/embedded_assets/console` as shown above.
- `cargo clippy --locked` fails: regenerate `rust/Cargo.lock` in a follow-up change and commit it when the deployment window allows.
